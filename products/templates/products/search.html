{# search.html #}
{# 검색 결과 화면 템플릿 #}

{% extends 'base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'products/css/search.css' %}">
{% endblock styles %}

{% block content %}
<div class="content-wrapper">

  <header class="header">
    <div class="left-group">
      {# 로고 이미지 #}
      <a href="{% url 'products:index' %}" class="main-link">
        <img src="{% static 'images/logo-gray.png' %}" alt="FINBOT Logo">
      </a>
    </div>

    <div class="right-group">
      {% if request.user.is_authenticated %}
        <a href="{% url 'accounts:update' %}" class="info-btn">회원 정보</a>
        <a href="{% url 'accounts:bookmark_list' %}" class="info-btn">관심 상품</a>
        <a href="{% url 'accounts:logout' %}" class="logout-btn">로그아웃</a>
      {% else %}
        <a href="{% url 'accounts:login' %}" class="logout-btn">로그인</a>
      {% endif %}
    </div>
  </header>

  {# 검색 창 #}
  <div class="search-header">
    <form class="search-bar" method="GET" action="{% url 'products:search' %}">
      <div class="search-input-wrapper">
        <input class="search-input" type="text" name="query" value="{{ query }}" placeholder="검색어를 입력하세요">
        <button type="submit" class="search-submit-btn">&#x2315;</button>
      </div>
    </form>
  </div>

  {# 검색 결과 #}
  <div class="result-container">
    {% if query %}
    <div class="result-list">
      {% if page_obj %}
      {% for p in page_obj %}
      <div class="result-item">
        <div class="result-bookmark">
          <a href="{% url "products:product_detail" p.fin_prdt_cd %}" class="product-name-link"><p class="product-name">{{ p.fin_prdt_nm }}</p></a>

          <form method="POST" action="{% url 'accounts:bookmark' p.fin_prdt_cd %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">

            {% if request.user in p.users.all %}
            <button type="submit" class="bookmark-btn bookmarked">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 3.5l2.3 4.7 5.2.8-3.8 3.7.9 5.2L12 15.8l-4.6 2.4.9-5.2-3.8-3.7 5.2-.8L12 3.5z" fill="currentColor">
              </svg>
            </button>
            {% else %}
            <button type="submit" class="bookmark-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 3.5l2.3 4.7 5.2.8-3.8 3.7.9 5.2L12 15.8l-4.6 2.4.9-5.2-3.8-3.7 5.2-.8L12 3.5z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round">
              </svg>
            </button>
            {% endif %}
          </form>
        </div>

        <div class="info-grid">

        <div class="label">회사명</div>
        <div class="value">{{ p.kor_co_nm }}</div>

        {% if p.category == "jeonse_loan" %}
          {% if p.jeonse_options.first.lend_rate_avg %}
            <div class="label">전월 취급 평균 금리</div>
            <div class="value">연 {{ p.jeonse_options.first.lend_rate_avg }} %</div>
          {% endif %}

        {% elif p.category == "installment_deposit" %}
          {% if p.installment_options.first.intr_rate2 %}
            <div class="label">적금 저축 금리</div>
            <div class="value">연 {{ p.installment_options.first.intr_rate2 }} %</div>
          {% endif %}

        {% elif p.category == "fixed_deposit" %}
          {% if p.fixed_options.first.intr_rate %}
            <div class="label">정기 예금 저축 금리</div>
            <div class="value">연 {{ p.fixed_options.first.intr_rate }} %</div>
          {% endif %}

        {% endif %}

        <div class="label">가입 방법</div>
        <div class="value">{{ p.join_way }}</div>

        <div class="label">상품 설명</div>
        <div class="value">{{ p.description }}</div>

      </div>

      </div>
      {% endfor %}

      <div class="pagination">
        {# 이전 페이지 #}
        {% if show_previous_10 %}
          <a href="?query={{ query }}&page={{ previous_page }}">이전</a>
        {% endif %}

        {# 페이지 번호 그룹 표시 (1부터 10까지) #}
        {% for num in page_obj.paginator.page_range %}
        {% if num >= start_page and num <= end_page %}
        {% if num == page_obj.number %}
        <span>{{ num }}</span>
        {% else %}
          <a href="?query={{ query }}&page={{ num }}">{{ num }}</a>
        {% endif %}
        {% endif %}
        {% endfor %}

        {# 다음 페이지 #}
        {% if show_next_10 %}
          <a href="?query={{ query }}&page={{ next_page }}">다음</a>
        {% endif %}
      </div>

      {% else %}
      <div class="no-result">
        <p>검색 결과가 없습니다.</p>
      </div>
      {% endif %}
    {% endif %}
    </div>
  </div>

  {# 채팅 페이지 버튼 #}
  <a href="{% url 'chat:current_chat' %}" class="chatbot-btn">
    <img src="{% static 'images/finbot-btn-long.png' %}" alt="FINBOT Chat">
  </a>
</div>
{% endblock content %}